# 通知管理测试用例文档

## 测试目标
验证通知管理系统的功能完整性、实时性和可靠性，确保能及时准确地向用户发送各类交易通知。

## 测试环境准备

### 前置条件
- 系统已安装Python 3.7+
- 所有依赖已安装（`pip install -r requirements.txt`）
- vn.py框架已正确配置
- 网络连接正常（用于邮件和Webhook测试）

### 测试数据准备
- 准备测试邮箱（建议使用Gmail、QQ邮箱等）
- 准备测试用Webhook URL（如钉钉机器人、企业微信等）
- 准备模拟交易数据用于触发通知

## 测试用例清单

### 1. 通知管理界面测试

#### TC-N01: 通知管理窗口打开测试
**测试目的**：验证通知管理窗口能正常打开
**前置条件**：主程序已启动
**测试步骤**：
1. 启动主程序：`python ui/main.py`
2. 点击主界面右上角的"通知管理"按钮
3. 观察窗口是否成功打开

**预期结果**：
- [ ] 通知管理窗口成功打开
- [ ] 窗口标题显示"通知管理"
- [ ] 窗口包含通知配置、规则设置、历史记录等完整界面

#### TC-N02: 通知配置显示测试
**测试目的**：验证通知配置界面正确显示
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 打开通知管理窗口
2. 观察顶部配置区域
3. 检查各配置项的初始状态

**预期结果**：
- [ ] 显示3种通知方式：弹窗、邮件、Webhook
- [ ] 显示5种通知规则：成交、订单、持仓、错误、风险
- [ ] 显示配置管理按钮：邮件配置、Webhook配置
- [ ] 显示声音提醒选项

### 2. 通知方式配置测试

#### TC-N03: 弹窗通知配置测试
**测试目的**：验证弹窗通知开关功能
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 取消勾选"弹窗通知"
2. 点击"保存所有设置"
3. 进行交易操作

**预期结果**：
- [ ] 设置成功保存
- [ ] 取消弹窗后不再显示弹窗通知
- [ ] 重新勾选后恢复弹窗通知

#### TC-N04: 邮件通知配置测试
**测试目的**：验证邮件通知配置功能
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 点击"邮件配置"按钮
2. 填写邮件配置：
   - 启用邮件通知：√
   - SMTP服务器：smtp.gmail.com
   - 端口：587
   - 用户名：your_email@gmail.com
   - 密码：your_password
   - 发件人：your_email@gmail.com
   - 收件人：your_email@gmail.com
3. 点击"保存"
4. 勾选"邮件通知"
5. 进行交易操作

**预期结果**：
- [ ] 邮件配置窗口正常打开
- [ ] 配置信息正确保存
- [ ] 交易时能收到邮件通知
- [ ] 邮件内容包含时间、类型、消息等完整信息

#### TC-N05: Webhook通知配置测试
**测试目的**：验证Webhook通知配置功能
**前置条件**：通知管理窗口已打开，有有效的Webhook URL
**测试步骤**：
1. 点击"Webhook配置"按钮
2. 填写Webhook配置：
   - 启用Webhook通知：√
   - URL：https://oapi.dingtalk.com/robot/send?access_token=xxx
   - 密钥：（如需要）
3. 点击"保存"
4. 勾选"Webhook通知"
5. 进行交易操作

**预期结果**：
- [ ] Webhook配置窗口正常打开
- [ ] 配置信息正确保存
- [ ] 交易时能收到Webhook通知
- [ ] 通知格式符合接收平台要求

### 3. 通知规则测试

#### TC-N06: 成交通知规则测试
**测试目的**：验证成交通知规则功能
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 确保"成交通知"已勾选
2. 进行一次模拟交易
3. 观察通知记录

**预期结果**：
- [ ] 成交后立即收到通知
- [ ] 通知包含品种、方向、数量、价格等交易信息
- [ ] 通知在通知列表中正确显示

#### TC-N07: 订单通知规则测试
**测试目的**：验证订单通知规则功能
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 确保"订单通知"已勾选
2. 提交一个新订单
3. 观察订单状态变化时的通知

**预期结果**：
- [ ] 订单提交时收到通知
- [ ] 订单成交时收到通知
- [ ] 订单取消时收到通知
- [ ] 通知包含订单状态信息

#### TC-N08: 错误通知规则测试
**测试目的**：验证错误通知规则功能
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 确保"错误通知"已勾选
2. 故意触发一个错误（如网络中断）
3. 观察错误通知

**预期结果**：
- [ ] 错误发生时立即收到通知
- [ ] 通知包含错误详情
- [ ] 通知级别为ERROR

#### TC-N09: 风险通知规则测试
**测试目的**：验证风险通知规则功能
**前置条件**：通知管理窗口已打开，风险管理已启用
**测试步骤**：
1. 确保"风险通知"已勾选
2. 触发风险事件（如超过亏损限制）
3. 观察风险通知

**预期结果**：
- [ ] 风险事件发生时立即收到通知
- [ ] 通知包含风险类型和详情
- [ ] 通知级别为WARNING或ERROR

### 4. 通知记录管理测试

#### TC-N10: 通知记录显示测试
**测试目的**：验证通知记录正确显示
**前置条件**：已有通知记录
**测试步骤**：
1. 打开通知管理窗口
2. 观察通知列表
3. 检查记录格式和内容

**预期结果**：
- [ ] 列表显示时间、类型、标题、消息
- [ ] 按时间倒序排列（最新在前）
- [ ] 最多显示100条记录

#### TC-N11: 通知统计测试
**测试目的**：验证通知统计功能
**前置条件**：已有通知记录
**测试步骤**：
1. 观察通知统计区域
2. 进行不同类型的交易操作
3. 观察统计数字变化

**预期结果**：
- [ ] 正确显示总通知数量
- [ ] 按类型显示成交、订单、错误等统计
- [ ] 统计数字随通知实时更新

#### TC-N12: 清空通知记录测试
**测试目的**：验证清空通知记录功能
**前置条件**：已有通知记录
**测试步骤**：
1. 点击"清空记录"按钮
2. 确认清空操作
3. 观察通知列表

**预期结果**：
- [ ] 弹出确认对话框
- [ ] 确认后记录清空
- [ ] 统计数字归零

### 5. 实时通知测试

#### TC-N13: 实时通知更新测试
**测试目的**：验证通知的实时性
**前置条件**：通知管理窗口已打开
**测试步骤**：
1. 保持通知管理窗口打开
2. 进行交易操作
3. 观察通知列表自动更新

**预期结果**：
- [ ] 每5秒自动刷新一次
- [ ] 新通知立即显示在列表顶部
- [ ] 界面无卡顿现象

#### TC-N14: 多通知方式并发测试
**测试目的**：验证多种通知方式同时工作
**前置条件**：已配置多种通知方式
**测试步骤**：
1. 启用弹窗、邮件、Webhook通知
2. 进行一次交易操作
3. 检查各通知方式的响应

**预期结果**：
- [ ] 所有启用的通知方式都能收到通知
- [ ] 通知内容一致
- [ ] 无重复或遗漏

### 6. 通知内容格式测试

#### TC-N15: 成交通知格式测试
**测试目的**：验证成交通知内容格式
**前置条件**：已启用成交通知
**测试步骤**：
1. 进行一次买入交易
2. 检查通知内容格式

**预期结果**：
- [ ] 格式："[品种] 成交: [方向] [数量]手 @[价格]"
- [ ] 示例："rb2410 成交: 多 1手 @3500"

#### TC-N16: 订单通知格式测试
**测试目的**：验证订单通知内容格式
**前置条件**：已启用订单通知
**测试步骤**：
1. 提交一个卖出订单
2. 检查订单通知格式

**预期结果**：
- [ ] 格式："[品种] 订单: [方向] [数量]手 @[价格] ([状态])"
- [ ] 示例："rb2410 订单: 空 1手 @3500 (已提交)"

### 7. 异常情况测试

#### TC-N17: 邮件发送失败测试
**测试目的**：验证邮件发送失败的处理
**前置条件**：已配置邮件通知
**测试步骤**：
1. 故意配置错误的SMTP服务器
2. 进行交易操作
3. 观察错误处理

**预期结果**：
- [ ] 记录邮件发送失败日志
- [ ] 不影响其他通知方式
- [ ] 系统继续正常运行

#### TC-N18: Webhook发送失败测试
**测试目的**：验证Webhook发送失败的处理
**前置条件**：已配置Webhook通知
**测试步骤**：
1. 故意配置错误的Webhook URL
2. 进行交易操作
3. 观察错误处理

**预期结果**：
- [ ] 记录Webhook发送失败日志
- [ ] 不影响其他通知方式
- [ ] 系统继续正常运行

### 8. 集成测试

#### TC-N19: 与主系统集成测试
**测试目的**：验证通知系统与主交易系统的集成
**前置条件**：主系统已连接CTP服务器
**测试步骤**：
1. 在主系统进行真实交易
2. 观察通知系统的响应
3. 检查数据一致性

**预期结果**：
- [ ] 主系统交易数据实时同步到通知系统
- [ ] 通知内容与实际交易一致
- [ ] 无数据延迟或丢失

#### TC-N20: 通知持久化测试
**测试目的**：验证通知数据的持久化存储
**前置条件**：已有通知记录
**测试步骤**：
1. 重启主程序
2. 打开通知管理窗口
3. 检查历史通知是否保留

**预期结果**：
- [ ] 历史通知记录完整保留
- [ ] 配置设置保持不变
- [ ] 统计数据正确恢复

## 测试执行记录表

| 测试用例 | 执行日期 | 执行人 | 结果 | 备注 |
|----------|----------|--------|------|------|
| TC-N01 | | | ☐/☐ | |
| TC-N02 | | | ☐/☐ | |
| TC-N03 | | | ☐/☐ | |
| TC-N04 | | | ☐/☐ | |
| TC-N05 | | | ☐/☐ | |
| TC-N06 | | | ☐/☐ | |
| TC-N07 | | | ☐/☐ | |
| TC-N08 | | | ☐/☐ | |
| TC-N09 | | | ☐/☐ | |
| TC-N10 | | | ☐/☐ | |
| TC-N11 | | | ☐/☐ | |
| TC-N12 | | | ☐/☐ | |
| TC-N13 | | | ☐/☐ | |
| TC-N14 | | | ☐/☐ | |
| TC-N15 | | | ☐/☐ | |
| TC-N16 | | | ☐/☐ | |
| TC-N17 | | | ☐/☐ | |
| TC-N18 | | | ☐/☐ | |
| TC-N19 | | | ☐/☐ | |
| TC-N20 | | | ☐/☐ | |

## 测试注意事项

1. **邮箱安全**：测试邮箱请使用专用测试邮箱，避免使用生产邮箱
2. **Webhook测试**：建议使用钉钉机器人或企业微信机器人进行测试
3. **网络要求**：邮件和Webhook测试需要稳定的网络连接
4. **测试频率**：避免过于频繁的测试，防止被邮件服务器限制
5. **隐私保护**：测试时避免使用真实的敏感信息

## 测试完成标准

- [ ] 所有通知方式测试通过
- [ ] 所有通知规则测试通过
- [ ] 实时通知功能正常
- [ ] 异常情况处理正确
- [ ] 与主系统集成良好
- [ ] 数据持久化正常

## 测试后清理

1. 清空所有测试通知记录
2. 重置通知设置为默认值
3. 清除测试用的邮箱和Webhook配置
4. 备份测试数据和配置文件
5. 生成完整的测试报告

## 配置示例

### 邮件配置示例（Gmail）
```json
{
  "enabled": true,
  "smtp_server": "smtp.gmail.com",
  "smtp_port": 587,
  "username": "your_email@gmail.com",
  "password": "your_app_password",
  "from_email": "your_email@gmail.com",
  "to_email": "your_email@gmail.com",
  "use_tls": true
}
```

### 钉钉Webhook配置示例
```json
{
  "enabled": true,
  "url": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
  "secret": "SECxxx"
}
```

### 企业微信Webhook配置示例
```json
{
  "enabled": true,
  "url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
}
```